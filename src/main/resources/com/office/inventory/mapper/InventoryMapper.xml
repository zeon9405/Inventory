<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.office.inventory.mapper.InventoryMapper">

	<resultMap id="empMap" type="com.office.inventory.vo.EmpVO">
		<id property="emp_id" column="emp_id" />
		<result property="password" column="password" />
		<result property="name" column="name" />
		<result property="dept" column="dept" />
		<result property="role" column="role" />
	</resultMap>

	<resultMap id="rentalMap"
		type="com.office.inventory.vo.RentalVO">
		<id property="rental_id" column="rental_id" />
		<result property="emp_id" column="emp_id" />
		<result property="item_id" column="item_id" />
		<result property="rent_date" column="rent_date" />
		<result property="ret_exp_date" column="ret_exp_date" />
		<result property="ret_act_date" column="ret_act_date" />
	</resultMap>

	<resultMap id="itemMap" type="com.office.inventory.vo.ItemVO">
		<id property="item_id" column="item_id" />
		<result property="item_name" column="item_name" />
		<result property="cat_id" column="cat_id" />
		<result property="item_price" column="item_price" />
		<result property="status" column="status" />
		<result property="quantity" column="quantity" />
		<result property="reg_date" column="reg_date" />

		<association property="categoryVO"
			javaType="com.office.inventory.vo.CategoryVO">
			<id property="cat_id" column="cat_id" />
			<result property="cat_name" column="cat_name" />
		</association>
	</resultMap>

	<select id="getItemListForUser" resultMap="itemMap">
		select * from item
		where status != 'deleted'
		order by item_id desc
	</select>

	<select id="getItemListForAdmin" resultMap="itemMap">
		select * from item
		order by item_id desc
	</select>

	<insert id="insertRental">
		INSERT INTO rental
		(rental_id, emp_id, item_id,
		rent_date, ret_exp_date)
		VALUES
		(0, #{empVO.emp_id},
		#{item_id}, now(),
		now()+ 7)
	</insert>

	<update id="updateItemCnt">
		UPDATE item
		SET quantity = quantity - 1
		WHERE item_id =
		#{item_id}
	</update>

	<select id="loginCheck" resultType="Integer">
		SELECT COUNT(*) FROM emp
		where emp_id = #{emp_id} and password = #{password}
	</select>

	<select id="getMyRentalList"
		resultType="com.office.inventory.vo.RentalVO">
		SELECT
		r.rental_id, r.emp_id, r.item_id, r.rent_date,
		r.ret_exp_date, r.ret_act_date, i.item_name,
		i.status
		FROM rental r
		JOIN
		item i ON
		r.item_id = i.item_id
		WHERE r.emp_id = #{emp_id}
		AND
		r.ret_act_date IS
		NULL
		ORDER BY r.rent_date DESC
	</select>

	<update id="updateReturnDate">
		update rental
		set ret_act_date = now()
		where rental_id
		= #{rendtal_id}
	</update>

	<update id="increaseQuantity">
		update item
		set quantity = quantity + 1
		where item_id =
		#{item_id}
	</update>

	<insert id="insertNewItem">
		insert into item (item_name, cat_id, item_price,
		quantity)
		values(#{item_name}, #{cat_id}, #{item_price}, #{quantity})
	</insert>

	<select id="getItemDetail"
		resultType="com.office.inventory.vo.ItemVO">
		SELECT * FROM item WHERE item_id = #{item_id}
	</select>

	<update id="updateItem">
		update item
		set item_name = #{item_name},
		quantity =
		#{quantity},
		item_price = #{item_price}
		where item_id = #{item_id}
	</update>

	<!-- 실제데이터 삭제에서 데이터상태변경으로 변경 -->
	<!-- <delete id="deleteItem"> delete from item where item_id = #{item_id} 
		</delete> -->

	<update id="deleteItem">
		UPDATE item
		SET status = 'deleted'
		WHERE item_id =
		#{item_id}
	</update>

	<select id="getRentalDetail"
		resultType="com.office.inventory.vo.RentalVO">
		select * from rental where item_id = #{item_id}
	</select>

	<select id="getAllCategories"
		resultType="com.office.inventory.vo.CategoryVO">
		SELECT *
		FROM item_category
		ORDER BY cat_id ASC
	</select>

	<select id="getAllRentalList"
		resultType="com.office.inventory.vo.RentalVO">
		SELECT
		r.rental_id,
		r.emp_id,
		e.name as emp_name, r.item_id,
		i.item_name,
		r.rent_date,
		r.ret_exp_date,
		r.ret_act_date,
		i.status as item_status
		FROM rental r
		JOIN item i ON r.item_id = i.item_id
		JOIN emp e ON r.emp_id = e.emp_id
		ORDER BY r.rent_date DESC
	</select>

	<!-- <select id="getAllItems" resultMap="itemMap"> SELECT i.*, c.cat_name 
		FROM item i JOIN item_category c ON i.cat_id = c.cat_id ORDER BY i.item_id 
		DESC </select> <update id="decreaseQuantity"> UPDATE item SET quantity = 
		quantity - 1 WHERE item_id = #{item_id} AND quantity > 0 </update> <insert 
		id="insertRental"> INSERT INTO rental (rental_id, emp_id, item_id, rent_date, 
		ret_exp_date) VALUES (0, 'user01', #{item_id}, now(), now()+ 7) </insert> 
		<update id="updateReturnDate"> UPDATE rental SET ret_act_date = now() WHERE 
		rental_id = #{rental_id} </update> <update id="increaseQuantity"> UPDATE 
		item SET quantity = quantity + 1 WHERE item_id = #{item_id} </update> -->
</mapper>